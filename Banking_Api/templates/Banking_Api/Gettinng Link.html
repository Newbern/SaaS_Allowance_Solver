<!DOCTYPE html>
<html>
<head>
    <title>Connect Bank with Plaid</title>
    <script src="https://cdn.plaid.com/link/v2/stable/link-initialize.js"></script>
</head>
<body>

    <button id="link-button">Connect Your Bank</button>

    <script>
        let linkToken = "";  // Will be populated by the backend

        // Get the link_token from Django backend
        async function getLinkToken() {
            const response = await fetch("/get_link_token/");
            const data = await response.json();
            linkToken = data.link_token;
        }

        // Initialize Plaid Link
        async function initializePlaidLink() {
            await getLinkToken();  // Get token first

            const handler = Plaid.create({
                token: linkToken,
                onSuccess: async function (public_token, metadata) {
                    console.log('Public Token:', public_token);
                    // Send public_token to the backend to exchange for access_token
                    const response = await fetch("/exchange_public_token/", {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json",
                        },
                        body: JSON.stringify({ public_token: public_token }),
                    });

                    const result = await response.json();
                    if (result.success) {
                        alert("Bank account connected successfully!");
                    } else {
                        alert("Error connecting account.");
                    }
                },
                onExit: function (err, metadata) {
                    if (err != null) {
                        console.error('Exit with error:', err);
                    }
                },
                onEvent: function (eventName, metadata) {
                    console.log('Event:', eventName);
                }
            });

            // Open Plaid Link when button is clicked
            document.getElementById('link-button').onclick = function () {
                handler.open();
            };
        }

        // Initialize Plaid Link on page load
        window.onload = initializePlaidLink;
    </script>

</body>
</html>
